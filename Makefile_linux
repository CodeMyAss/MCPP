OPTIMIZATION=-O0 -g -fno-inline -fno-elide-constructors -DDEBUG
#OPTIMIZATION=-O3
OPTS_SHARED=-static-libgcc -static-libstdc++ -Wall -Wpedantic -fno-rtti -std=gnu++11 -I include -Dlinux -fPIC
GPP=/opt/gcc-4.8.0/bin/g++ $(OPTS_SHARED) $(OPTIMIZATION)


DEPS=include/aes_128_cfb_8.hpp include/chunk.hpp include/client.hpp include/common.hpp include/compression.hpp include/data_provider.hpp include/event.hpp include/hash.hpp include/metadata.hpp include/mod.hpp include/mod_loader.hpp include/nbt.hpp include/network.hpp include/packet.hpp include/packet_router.hpp include/random.hpp include/rsa_key.hpp include/server.hpp include/sha1.hpp include/thread_pool.hpp include/typedefs.hpp


#	DEFAULT

.PHONY: all
all: mcpp front_end

.PHONY: clean
clean:
	$(RM) obj/*
	
.PHONY: cleanall
cleanall: clean
	$(RM) bin/*
	
	
#	MCPP MAIN LIBRARY

.PHONY: mcpp
mcpp: bin/mcpp.so

bin/mcpp.so: \
obj/server.o \
obj/mod.o \
obj/nbt.o \
obj/network.o \
obj/packet.o \
obj/packet_factory.o \
obj/packet_router.o \
obj/compression.o \
obj/rsa_key.o \
obj/aes_128_cfb_8.o \
obj/chunk.o \
obj/metadata.o \
obj/client.o \
obj/client_list.o \
obj/url.o \
obj/http_handler.o \
obj/http_request.o \
obj/mod_loader.o \
obj/random.o \
obj/thread_pool.o \
obj/thread_pool_handle.o \
obj/sha1.o \
obj/new_delete.o \
bin/data_provider.so
	$(GPP) -shared -o $@ obj/server.o obj/new_delete.o obj/mod.o obj/nbt.o obj/network.o obj/packet.o obj/packet_factory.o obj/packet_router.o obj/compression.o obj/rsa_key.o obj/aes_128_cfb_8.o obj/chunk.o obj/metadata.o obj/client.o obj/client_list.o obj/url.o obj/http_handler.o obj/http_request.o obj/mod_loader.o obj/random.o obj/thread_pool.o obj/thread_pool_handle.o obj/sha1.o -lrleahy -lcrypto -lz -lcurl bin/data_provider.so

obj/server.o: src/server.cpp $(DEPS)
	$(GPP) src/server.cpp -c -o $@

obj/mod.o: src/mod.cpp $(DEPS)
	$(GPP) src/mod.cpp -c -o $@
	
obj/client.o: src/client.cpp $(DEPS)
	$(GPP) src/client.cpp -c -o $@
	
obj/client_list.o: src/client_list.cpp $(DEPS)
	$(GPP) src/client_list.cpp -c -o $@
	
obj/mod_loader.o: src/mod_loader.cpp $(DEPS)
	$(GPP) src/mod_loader.cpp -c -o $@
	
obj/new_delete.o: src/new_delete.cpp
	$(GPP) $? -c -o $@

	
#	MINECRAFT DATA FORMAT INTEROP
	
obj/nbt.o: src/nbt.cpp $(DEPS)
	$(GPP) src/nbt.cpp -c -o $@
	
obj/compression.o: src/compression.cpp $(DEPS)
	$(GPP) src/compression.cpp -c -o $@
	
obj/chunk.o: src/chunk.cpp $(DEPS)
	$(GPP) src/chunk.cpp -c -o $@
	
obj/metadata.o: src/metadata.cpp $(DEPS)
	$(GPP) src/metadata.cpp -c -o $@
	
	
#	NETWORK STACK

.PHONY: network_stack
network_stack: obj/network.o

obj/network.o: src/network_linux.cpp src/network.cpp $(DEPS)
	$(GPP) src/network.cpp -c -o $@
	

#	MINECRAFT COMMUNICATIONS
	
obj/packet.o: src/packet.cpp src/protocol_analysis.cpp $(DEPS)
	$(GPP) src/packet.cpp -c -o $@
	
obj/packet_factory.o: src/packet_factory.cpp $(DEPS)
	$(GPP) src/packet_factory.cpp -c -o $@
	
obj/packet_router.o: src/packet_router.cpp $(DEPS)
	$(GPP) src/packet_router.cpp -c -o $@
	
obj/rsa_key.o: src/rsa_key.cpp $(DEPS)
	$(GPP) src/rsa_key.cpp -c -o $@
	
obj/aes_128_cfb_8.o: src/aes_128_cfb_8.cpp $(DEPS)
	$(GPP) src/aes_128_cfb_8.cpp -c -o $@
	
obj/sha1.o: src/sha1.cpp $(DEPS)
	$(GPP) src/sha1.cpp -c -o $@
	

#	HTTP

obj/url.o: src/url.cpp include/url.hpp
	$(GPP) src/url.cpp -c -o $@
	
obj/http_handler.o: src/http_handler.cpp src/http_handler_callbacks.cpp include/http_handler.hpp
	$(GPP) src/http_handler.cpp -c -o $@
	
obj/http_request.o: src/http_request.cpp include/http_handler.hpp
	$(GPP) src/http_request.cpp -c -o $@
	
	
#	RANDOM NUMBER GENERATION

obj/random.o: src/random.cpp $(DEPS)
	$(GPP) src/random.cpp -c -o $@


#	DATA PROVIDERS

.PHONY: data_providers
data_providers: bin/data_provider.so

bin/data_provider.so: bin/data_providers/mysql_data_provider.so
	cp bin/data_providers/mysql_data_provider.so bin/data_provider.so
	
bin/data_providers/mysql_data_provider.so: obj/mysql_data_provider.o obj/data_provider.o obj/thread_pool.o obj/thread_pool_handle.o obj/new_delete.o include/data_provider.hpp include/mysql_data_provider.hpp
	$(GPP) -shared -o bin/data_providers/data_provider.so obj/mysql_data_provider.o obj/data_provider.o -lmysqlclient -lrleahy obj/thread_pool.o obj/thread_pool_handle.o obj/new_delete.o
	mv bin/data_providers/data_provider.so bin/data_providers/mysql_data_provider.so

obj/mysql_data_provider.o: src/mysql_data_provider.cpp src/login_info.cpp include/data_provider.hpp include/mysql_data_provider.hpp
	$(GPP) src/mysql_data_provider.cpp -c -o $@
	
obj/data_provider.o: src/data_provider.cpp include/data_provider.hpp
	$(GPP) src/data_provider.cpp -c -o $@
	

#	THREAD POOL

.PHONY: thread_pool
thread_pool: obj/thread_pool.o obj/thread_pool_handle.o include/thread_pool.hpp

obj/thread_pool.o: src/thread_pool.cpp include/thread_pool.hpp
	$(GPP) src/thread_pool.cpp -c -o $@
	
obj/thread_pool_handle.o: src/thread_pool_handle.cpp include/thread_pool.hpp
	$(GPP) src/thread_pool_handle.cpp -c -o $@
	
	
#	MODULES

.PHONY: mods
mods: \
bin/mods/ping.dll \
bin/mods/auth.dll \
bin/mods/keep_alive.dll \
bin/mods/chat.dll \
bin/mods/disconnect.dll \
bin/mods/player_list.dll \
bin/mods/op.dll \
bin/mods/ban.dll \
bin/chat_mods/basic_chat.dll \
bin/chat_mods/whisper.dll \
bin/chat_mods/chat_login.dll \
bin/chat_mods/ban_info.dll \
bin/chat_mods/info.dll \
bin/chat_mods/chat_op.dll \
bin/chat_mods/kick.dll


#	PING SUPPORT

bin/mods/ping.dll: src/ping/main.cpp bin/mcpp.dll bin/rleahy_lib.dll obj/new_delete.o
	$(GPP) -shared -o $@ src/ping/main.cpp obj/new_delete.o bin/mcpp.dll bin/rleahy_lib.dll
	

#	AUTHENTICATION SUPPORT

bin/mods/auth.dll: src/auth/main.cpp bin/mcpp.dll bin/rleahy_lib.dll obj/new_delete.o
	$(GPP) -shared -o $@ src/auth/main.cpp obj/new_delete.o bin/mcpp.dll bin/rleahy_lib.dll
	
	
#	KEEP ALIVE SUPPORT

bin/mods/keep_alive.dll: src/keep_alive/main.cpp bin/mcpp.dll bin/rleahy_lib.dll obj/new_delete.o
	$(GPP) -shared -o $@ src/keep_alive/main.cpp obj/new_delete.o bin/mcpp.dll bin/rleahy_lib.dll
	
	
#	DISCONNECT SUPPORT

bin/mods/disconnect.dll: src/disconnect/main.cpp bin/mcpp.dll bin/rleahy_lib.dll obj/new_delete.o
	$(GPP) -shared -o $@ src/disconnect/main.cpp obj/new_delete.o bin/mcpp.dll bin/rleahy_lib.dll
	
	
#	CHAT SUPPORT

bin/mods/chat.dll: src/chat/main.cpp bin/mcpp.dll bin/rleahy_lib.dll obj/new_delete.o src/chat/chat_misc.cpp src/chat/chat_parser.cpp
	$(GPP) -shared -o $@ src/chat/main.cpp obj/new_delete.o bin/mcpp.dll bin/rleahy_lib.dll src/chat/chat_misc.cpp src/chat/chat_parser.cpp
	
	
#	PLAYER LIST SUPPORT

bin/mods/player_list.dll: bin/mcpp.dll bin/rleahy_lib.dll obj/new_delete.o src/player_list/main.cpp
	$(GPP) -shared -o $@ bin/mcpp.dll bin/rleahy_lib.dll obj/new_delete.o src/player_list/main.cpp
	
	
#	OPERATOR SUPPORT

bin/mods/op.dll: bin/mcpp.dll bin/rleahy_lib.dll bin/data_provider.dll src/op/main.cpp obj/new_delete.o
	$(GPP) -shared -o $@ bin/mcpp.dll bin/data_provider.dll bin/rleahy_lib.dll obj/new_delete.o src/op/main.cpp
	
	
#	BAN SUPPORT

bin/mods/ban.dll: bin/mcpp.dll bin/rleahy_lib.dll bin/data_provider.dll src/ban/main.cpp obj/new_delete.o
	$(GPP) -shared -o $@ bin/mcpp.dll bin/data_provider.dll bin/rleahy_lib.dll obj/new_delete.o src/ban/main.cpp
	

#	CHAT SUB-MODULES


#	GLOBAL CHAT

bin/chat_mods/basic_chat.dll: bin/mods/chat.dll src/basic_chat/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll
	$(GPP) -shared -o $@ src/basic_chat/main.cpp obj/new_delete.o bin/mcpp.dll bin/rleahy_lib.dll bin/mods/chat.dll
	
#	WHISPERS

bin/chat_mods/whisper.dll: bin/mods/chat.dll src/whisper/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll
	$(GPP) -shared -o $@ src/whisper/main.cpp obj/new_delete.o bin/mcpp.dll bin/rleahy_lib.dll bin/mods/chat.dll
	
#	LOGIN/LOGOUT BROADCASTS

bin/chat_mods/chat_login.dll: bin/mods/chat.dll src/chat_login/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll
	$(GPP) -shared -o $@ src/chat_login/main.cpp obj/new_delete.o bin/mcpp.dll bin/rleahy_lib.dll bin/mods/chat.dll
	
#	INFORMATION THROUGH CHAT

bin/chat_mods/info.dll: bin/mods/chat.dll src/info/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll bin/mods/op.dll
	$(GPP) -shared -o $@ src/info/main.cpp obj/new_delete.o bin/mcpp.dll bin/rleahy_lib.dll bin/mods/chat.dll bin/mods/op.dll
	
#	INFORMATION ABOUT BANS THROUGH CHAT

bin/chat_mods/ban_info.dll: bin/mods/chat.dll bin/mods/op.dll bin/mods/ban.dll src/ban_info/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll
	$(GPP) -shared -o $@ bin/mods/chat.dll bin/mods/op.dll bin/mods/ban.dll src/ban_info/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll
	
#	OP/DEOP THROUGH CHAT

bin/chat_mods/chat_op.dll: bin/mods/chat.dll bin/mods/op.dll src/chat_op/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll
	$(GPP) -shared -o $@ bin/mods/chat.dll bin/mods/op.dll src/chat_op/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll
	
#	KICKING THROUGH CHAT

bin/chat_mods/kick.dll: bin/mods/chat.dll bin/mods/op.dll src/kick/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll
	$(GPP) -shared -o $@ bin/mods/chat.dll bin/mods/op.dll src/kick/main.cpp obj/new_delete.o bin/rleahy_lib.dll bin/mcpp.dll
	
	
#	SERVER FRONT-END

.PHONY: front_end
front_end: bin/server

bin/server: src/test_front_end/main.cpp src/test_front_end/test.cpp bin/mcpp.so obj/new_delete.o
	$(GPP) -o $@ src/test_front_end/main.cpp bin/mcpp.so -lrleahy obj/new_delete.o
	
bin/mcpp.exe: src/interactive_front_end/main.cpp bin/mcpp.dll bin/rleahy_lib.dll bin/data_provider.dll obj/new_delete.o
	$(GPP) -o $@ src/interactive_front_end/main.cpp bin/mcpp.dll bin/rleahy_lib.dll bin/data_provider.dll obj/new_delete.o
	
	
#	TEST


.PHONY: test
test: bin/test.exe

bin/test.exe: bin/rleahy_lib.dll src/test/test.cpp obj/thread_pool.o obj/network.o obj/thread_pool_handle.o
	$(GPP) -o $@ bin/rleahy_lib.dll obj/thread_pool.o obj/network.o src/test/test.cpp -lws2_32 obj/thread_pool_handle.o