OPTIMIZATION=-O0 -g -fno-inline -fno-elide-constructors
#OPTIMIZATION=-O3
OPTS_SHARED=-static-libgcc -static-libstdc++ -Wall -Wpedantic -Werror -fno-rtti -std=gnu++11 -I include -Dlinux -fPIC
GPP=g++ $(OPTS_SHARED) $(OPTIMIZATION)
LINK=-Wl,-rpath,'$$ORIGIN' -Wl,-rpath-link,bin -Wl,-rpath-link,bin/mods -Wl,-rpath-link,bin/chat_mods


DEPS=include/aes_128_cfb_8.hpp include/chunk.hpp include/client.hpp include/common.hpp include/compression.hpp include/data_provider.hpp include/event.hpp include/hash.hpp include/metadata.hpp include/mod.hpp include/mod_loader.hpp include/nbt.hpp include/network.hpp include/packet.hpp include/packet_router.hpp include/random.hpp include/rsa_key.hpp include/server.hpp include/sha1.hpp include/thread_pool.hpp include/typedefs.hpp bin/rleahylib.so


#	DEFAULT

.PHONY: all
all: mcpp front_end mods

.PHONY: clean
clean:
	-$(RM) obj/*
	
.PHONY: cleanall
cleanall: clean
	-$(RM) bin/*
	-$(RM) bin/data_providers/*
	-$(RM) bin/mods/*
	-$(RM) bin/chat_mods/*
	
	
#	RLEAHYLIB

bin/rleahylib.so: ../RLeahyLib/release/bin/rleahylib.so
	-rm -f ./bin/rleahylib.so
	-rm -f ./include/rleahylib/*
	yes | cp ../RLeahyLib/release/bin/rleahylib.so ./bin
	yes | cp ../RLeahyLib/release/include/* ./include/rleahylib
	
	
#	MCPP MAIN LIBRARY

.PHONY: mcpp
mcpp: bin/mcpp.so

bin/mcpp.so: \
obj/server.o \
obj/mod.o \
obj/nbt.o \
obj/network.o \
obj/packet.o \
obj/packet_factory.o \
obj/packet_router.o \
obj/compression.o \
obj/rsa_key.o \
obj/aes_128_cfb_8.o \
obj/chunk.o \
obj/metadata.o \
obj/client.o \
obj/client_list.o \
obj/url.o \
obj/http_handler.o \
obj/http_request.o \
obj/mod_loader.o \
obj/random.o \
obj/thread_pool.o \
obj/thread_pool_handle.o \
obj/sha1.o \
obj/new_delete.o \
bin/data_provider.so
	$(GPP) -shared -o $@ obj/server.o obj/new_delete.o obj/mod.o obj/nbt.o obj/network.o obj/packet.o obj/packet_factory.o obj/packet_router.o obj/compression.o obj/rsa_key.o obj/aes_128_cfb_8.o obj/chunk.o obj/metadata.o obj/client.o obj/client_list.o obj/url.o obj/http_handler.o obj/http_request.o obj/mod_loader.o obj/random.o obj/thread_pool.o obj/thread_pool_handle.o obj/sha1.o -lcrypto -lz -lcurl bin/data_provider.so bin/rleahylib.so $(LINK) -Wl,-soname,mcpp.so

obj/server.o: src/server.cpp src/server_getters_setters.cpp src/server_setup.cpp $(DEPS)
	$(GPP) src/server.cpp -c -o $@

obj/mod.o: src/mod.cpp $(DEPS)
	$(GPP) src/mod.cpp -c -o $@
	
obj/client.o: src/client.cpp $(DEPS)
	$(GPP) src/client.cpp -c -o $@
	
obj/client_list.o: src/client_list.cpp $(DEPS)
	$(GPP) src/client_list.cpp -c -o $@
	
obj/mod_loader.o: src/mod_loader.cpp $(DEPS)
	$(GPP) src/mod_loader.cpp -c -o $@
	
obj/new_delete.o: src/new_delete.cpp
	$(GPP) $? -c -o $@

	
#	MINECRAFT DATA FORMAT INTEROP
	
obj/nbt.o: src/nbt.cpp $(DEPS)
	$(GPP) src/nbt.cpp -c -o $@
	
obj/compression.o: src/compression.cpp $(DEPS)
	$(GPP) src/compression.cpp -c -o $@
	
obj/chunk.o: src/chunk.cpp $(DEPS)
	$(GPP) src/chunk.cpp -c -o $@
	
obj/metadata.o: src/metadata.cpp $(DEPS)
	$(GPP) src/metadata.cpp -c -o $@
	
	
#	NETWORK STACK

.PHONY: network_stack
network_stack: obj/network.o

obj/network.o: src/network_linux.cpp src/network.cpp $(DEPS)
	$(GPP) src/network.cpp -c -o $@
	

#	MINECRAFT COMMUNICATIONS
	
obj/packet.o: src/packet.cpp src/protocol_analysis.cpp $(DEPS)
	$(GPP) src/packet.cpp -c -o $@
	
obj/packet_factory.o: src/packet_factory.cpp $(DEPS)
	$(GPP) src/packet_factory.cpp -c -o $@
	
obj/packet_router.o: src/packet_router.cpp $(DEPS)
	$(GPP) src/packet_router.cpp -c -o $@
	
obj/rsa_key.o: src/rsa_key.cpp $(DEPS)
	$(GPP) src/rsa_key.cpp -c -o $@
	
obj/aes_128_cfb_8.o: src/aes_128_cfb_8.cpp $(DEPS)
	$(GPP) src/aes_128_cfb_8.cpp -c -o $@
	
obj/sha1.o: src/sha1.cpp $(DEPS)
	$(GPP) src/sha1.cpp -c -o $@
	

#	HTTP

obj/url.o: src/url.cpp include/url.hpp bin/rleahylib.so
	$(GPP) src/url.cpp -c -o $@
	
obj/http_handler.o: src/http_handler.cpp src/http_handler_callbacks.cpp include/http_handler.hpp bin/rleahylib.so
	$(GPP) src/http_handler.cpp -c -o $@
	
obj/http_request.o: src/http_request.cpp include/http_handler.hpp bin/rleahylib.so
	$(GPP) src/http_request.cpp -c -o $@
	
	
#	RANDOM NUMBER GENERATION

obj/random.o: src/random.cpp $(DEPS)
	$(GPP) src/random.cpp -c -o $@


#	DATA PROVIDERS

.PHONY: data_providers
data_providers: bin/data_provider.so

bin/data_provider.so: bin/data_providers/mysql_data_provider.so
	cp bin/data_providers/mysql_data_provider.so bin/data_provider.so
	
bin/data_providers/mysql_data_provider.so: obj/mysql_data_provider.o obj/data_provider.o obj/thread_pool.o obj/thread_pool_handle.o obj/new_delete.o
	$(GPP) -shared -o bin/data_providers/data_provider.so obj/mysql_data_provider.o obj/data_provider.o -L /usr/lib64/mysql -lmysqlclient bin/rleahylib.so obj/thread_pool.o obj/thread_pool_handle.o obj/new_delete.o $(LINK) -Wl,-soname,data_provider.so
	mv bin/data_providers/data_provider.so bin/data_providers/mysql_data_provider.so

obj/mysql_data_provider.o: src/mysql_data_provider.cpp src/login_info.cpp include/data_provider.hpp include/mysql_data_provider.hpp bin/rleahylib.so include/column.hpp include/thread_pool.hpp
	$(GPP) src/mysql_data_provider.cpp -c -o $@
	
obj/data_provider.o: src/data_provider.cpp include/data_provider.hpp bin/rleahylib.so
	$(GPP) src/data_provider.cpp -c -o $@
	

#	THREAD POOL

.PHONY: thread_pool
thread_pool: obj/thread_pool.o obj/thread_pool_handle.o include/thread_pool.hpp

obj/thread_pool.o: src/thread_pool.cpp include/thread_pool.hpp bin/rleahylib.so
	$(GPP) src/thread_pool.cpp -c -o $@
	
obj/thread_pool_handle.o: src/thread_pool_handle.cpp include/thread_pool.hpp bin/rleahylib.so
	$(GPP) src/thread_pool_handle.cpp -c -o $@
	
	
#	MODULES

.PHONY: mods
mods: \
bin/mods/ping.so \
bin/mods/auth.so \
bin/mods/keep_alive.so \
bin/mods/chat.so \
bin/mods/disconnect.so \
bin/mods/player_list.so \
bin/mods/op.so \
bin/mods/ban.so \
bin/chat_mods/basic_chat.so \
bin/chat_mods/whisper.so \
bin/chat_mods/chat_login.so \
bin/chat_mods/ban_info.so \
bin/chat_mods/info.so \
bin/chat_mods/chat_op.so \
bin/chat_mods/kick.so


#	PING SUPPORT

bin/mods/ping.so: src/ping/main.cpp bin/mcpp.so obj/new_delete.o $(DEPS)
	$(GPP) -shared -o $@ src/ping/main.cpp obj/new_delete.o bin/mcpp.so bin/rleahylib.so $(LINK) -Wl,-soname,ping.so
	

#	AUTHENTICATION SUPPORT

bin/mods/auth.so: src/auth/main.cpp bin/mcpp.so obj/new_delete.o $(DEPS)
	$(GPP) -shared -o $@ src/auth/main.cpp obj/new_delete.o bin/mcpp.so bin/rleahylib.so $(LINK) -Wl,-soname,auth.so
	
	
#	KEEP ALIVE SUPPORT

bin/mods/keep_alive.so: src/keep_alive/main.cpp bin/mcpp.so obj/new_delete.o $(DEPS)
	$(GPP) -shared -o $@ src/keep_alive/main.cpp obj/new_delete.o bin/mcpp.so bin/rleahylib.so $(LINK) -Wl,-soname,keep_alive.so
	
	
#	DISCONNECT SUPPORT

bin/mods/disconnect.so: src/disconnect/main.cpp bin/mcpp.so bin/rleahylib.so obj/new_delete.o $(DEPS)
	$(GPP) -shared -o $@ src/disconnect/main.cpp obj/new_delete.o bin/mcpp.so bin/rleahylib.so $(LINK) -Wl,-soname,disconnect.so
	
	
#	CHAT SUPPORT

bin/mods/chat.so: src/chat/main.cpp bin/mcpp.so obj/new_delete.o src/chat/chat_misc.cpp src/chat/chat_parser.cpp $(DEPS) include/chat/chat.hpp
	$(GPP) -shared -o $@ src/chat/main.cpp obj/new_delete.o bin/mcpp.so bin/rleahylib.so src/chat/chat_misc.cpp src/chat/chat_parser.cpp $(LINK) -Wl,-soname,chat.so
	
	
#	PLAYER LIST SUPPORT

bin/mods/player_list.so: bin/mcpp.so obj/new_delete.o src/player_list/main.cpp $(DEPS)
	$(GPP) -shared -o $@ bin/mcpp.so bin/rleahylib.so obj/new_delete.o src/player_list/main.cpp $(LINK) -Wl,-soname,player_list.so
	
	
#	OPERATOR SUPPORT

bin/mods/op.so: bin/mcpp.so bin/data_provider.so src/op/main.cpp obj/new_delete.o $(DEPS) include/op/op.hpp
	$(GPP) -shared -o $@ bin/mcpp.so bin/data_provider.so bin/rleahylib.so obj/new_delete.o src/op/main.cpp $(LINK) -Wl,-soname,op.so
	
	
#	BAN SUPPORT

bin/mods/ban.so: bin/mcpp.so bin/data_provider.so src/ban/main.cpp obj/new_delete.o $(DEPS) include/ban/ban.hpp
	$(GPP) -shared -o $@ bin/mcpp.so bin/data_provider.so bin/rleahylib.so obj/new_delete.o src/ban/main.cpp $(LINK) -Wl,-soname,ban.so
	

#	CHAT SUB-MODULES


#	GLOBAL CHAT

bin/chat_mods/basic_chat.so: bin/mods/chat.so src/basic_chat/main.cpp obj/new_delete.o bin/mcpp.so $(DEPS) include/chat/chat.hpp
	$(GPP) -shared -o $@ src/basic_chat/main.cpp obj/new_delete.o bin/mcpp.so bin/rleahylib.so bin/mods/chat.so $(LINK) -Wl,-soname,basic_chat.so
	
#	WHISPERS

bin/chat_mods/whisper.so: bin/mods/chat.so src/whisper/main.cpp obj/new_delete.o bin/mcpp.so $(DEPS) include/chat/chat.hpp
	$(GPP) -shared -o $@ src/whisper/main.cpp obj/new_delete.o bin/mcpp.so bin/rleahylib.so bin/mods/chat.so $(LINK) -Wl,-soname,whisper.so
	
#	LOGIN/LOGOUT BROADCASTS

bin/chat_mods/chat_login.so: bin/mods/chat.so src/chat_login/main.cpp obj/new_delete.o bin/mcpp.so $(DEPS) include/chat/chat.hpp
	$(GPP) -shared -o $@ src/chat_login/main.cpp obj/new_delete.o bin/mcpp.so bin/rleahylib.so bin/mods/chat.so $(LINK) -Wl,-soname,chat_login.so
	
#	INFORMATION THROUGH CHAT

bin/chat_mods/info.so: bin/mods/chat.so src/info/main.cpp obj/new_delete.o bin/mcpp.so bin/mods/op.so $(DEPS) include/chat/chat.hpp include/op/op.hpp src/info/posix.cpp
	$(GPP) -shared -o $@ src/info/main.cpp obj/new_delete.o bin/mcpp.so bin/rleahylib.so bin/mods/chat.so bin/mods/op.so $(LINK) -Wl,-soname,info.so
	
#	INFORMATION ABOUT BANS THROUGH CHAT

bin/chat_mods/ban_info.so: bin/mods/chat.so bin/mods/op.so bin/mods/ban.so src/ban_info/main.cpp obj/new_delete.o bin/mcpp.so $(DEPS) include/ban/ban.hpp include/chat/chat.hpp include/op/op.hpp
	$(GPP) -shared -o $@ bin/mods/chat.so bin/mods/op.so bin/mods/ban.so src/ban_info/main.cpp obj/new_delete.o bin/rleahylib.so bin/mcpp.so $(LINK) -Wl,-soname,ban_info.so
	
#	OP/DEOP THROUGH CHAT

bin/chat_mods/chat_op.so: bin/mods/chat.so bin/mods/op.so src/chat_op/main.cpp obj/new_delete.o bin/mcpp.so $(DEPS) include/chat/chat.hpp include/op/op.hpp
	$(GPP) -shared -o $@ bin/mods/chat.so bin/mods/op.so src/chat_op/main.cpp obj/new_delete.o bin/rleahylib.so bin/mcpp.so $(LINK) -Wl,-soname,chat_op.so
	
#	KICKING THROUGH CHAT

bin/chat_mods/kick.so: bin/mods/chat.so bin/mods/op.so src/kick/main.cpp obj/new_delete.o bin/mcpp.so $(DEPS) include/chat/chat.hpp include/op/op.hpp
	$(GPP) -shared -o $@ bin/mods/chat.so bin/mods/op.so src/kick/main.cpp obj/new_delete.o bin/rleahylib.so bin/mcpp.so $(LINK) -Wl,-soname,kick.so
	
	
#	SERVER FRONT-END

.PHONY: front_end
front_end: bin/server

bin/server: src/test_front_end/main.cpp src/test_front_end/test.cpp bin/mcpp.so obj/new_delete.o $(DEPS)
	$(GPP) -o $@ src/test_front_end/main.cpp bin/mcpp.so bin/rleahylib.so obj/new_delete.o $(LINK)
	
bin/mcpp: src/interactive_front_end/main.cpp bin/mcpp.so bin/data_provider.so obj/new_delete.o $(DEPS)
	$(GPP) -o $@ src/interactive_front_end/main.cpp bin/mcpp.so bin/rleahylib.so bin/data_provider.so obj/new_delete.o $(LINK)
	
	
#	TEST


.PHONY: test
test: bin/test.exe

bin/test: src/test/test.cpp obj/thread_pool.o obj/network.o obj/thread_pool_handle.o
	$(GPP) -o $@ bin/rleahylib.so obj/thread_pool.o obj/network.o src/test/test.cpp obj/thread_pool_handle.o